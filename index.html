<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube → MP3 (웹 UI)</title>

<body style="font-family:system-ui;max-width:760px;margin:36px auto;padding:0 16px;">
  <h1 style="margin-bottom:12px;">YouTube → MP3</h1>

  <!-- API 키 (서버의 API_KEY와 동일해야 함) -->
  <label>API Key
    <input id="key" type="password" placeholder="API Key"
           style="width:100%;padding:10px;margin:6px 0 12px 0;">
  </label>

  <!-- URL 입력 -->
  <label>YouTube URL
    <input id="url" type="url" placeholder="https://www.youtube.com/watch?v=..."
           style="width:100%;padding:10px;margin:6px 0 16px 0;">
  </label>

  <!-- 옵션들 -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <label>Audio format
      <select id="fmt" style="width:100%;padding:10px;">
        <option value="mp3">mp3</option>
        <option value="m4a">m4a</option>
        <option value="flac">flac</option>
        <option value="wav">wav</option>
        <option value="opus">opus</option>
      </select>
    </label>

    <label>Audio quality (0 = 최고)
      <select id="aq" style="width:100%;padding:10px;">
        <option value="0">0 (best)</option>
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </label>
  </div>

  <div style="margin-top:14px;">
    <label style="display:block;margin:6px 0;">
      <input type="checkbox" id="embedMeta"> 메타데이터 임베드 (--embed-metadata)
    </label>
    <label style="display:block;margin:6px 0;">
      <input type="checkbox" id="embedThumb"> 썸네일 임베드 (--embed-thumbnail)
    </label>

    <div style="display:flex;gap:8px;align-items:center;margin:6px 0;">
      <label><input type="checkbox" id="convThumb"> 썸네일 변환 (--convert-thumbnails)</label>
      <select id="thumbFmt" style="padding:8px;">
        <option value="jpg">jpg</option>
        <option value="png">png</option>
        <option value="webp">webp</option>
      </select>
    </div>
  </div>

  <button id="go" style="margin-top:14px;padding:12px 16px;font-size:16px;">Convert & Download</button>
  <span id="status" style="margin-left:10px;color:#666;"></span>

  <script>
    // 마지막 API Key 기억 (localStorage)
    const keyEl = document.getElementById('key');
    keyEl.value = localStorage.getItem('apiKey') || '';
    keyEl.addEventListener('change', () => localStorage.setItem('apiKey', keyEl.value));

    async function convert() {
      const key = keyEl.value.trim();
      const url = document.getElementById('url').value.trim();
      const fmt = document.getElementById('fmt').value;
      const aq  = document.getElementById('aq').value;
      const embedMeta  = document.getElementById('embedMeta').checked;
      const embedThumb = document.getElementById('embedThumb').checked;
      const convThumb  = document.getElementById('convThumb').checked;
      const thumbFmt   = document.getElementById('thumbFmt').value;
      const status = document.getElementById('status');

      if (!url) { alert('YouTube URL을 입력하세요'); return; }
      if (!key) { alert('API Key를 입력하세요'); return; }

      // 허용된 플래그만 args에 담기 (서버 화이트리스트와 일치)
      const args = [
        "--audio-format", fmt,
        "--audio-quality", aq
      ];
      if (embedMeta)  args.push("--embed-metadata");
      if (embedThumb) args.push("--embed-thumbnail");
      if (convThumb)  args.push("--convert-thumbnails", thumbFmt);

      status.textContent = "변환 중... 잠시만요.";

      try {
        const res = await fetch("/cli", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-API-Key": key },
          body: JSON.stringify({ url, args })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || ("HTTP " + res.status));
        }

        // 다운로드
        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "audio.mp3"; // 서버가 uuid로 내려주므로 여기 이름은 임시
        a.click();
        URL.revokeObjectURL(a.href);
        status.textContent = "완료!";
      } catch (e) {
        status.textContent = "오류: " + e.message;
      }
    }

    document.getElementById('go').addEventListener('click', convert);
  </script>
</body>
</html>
